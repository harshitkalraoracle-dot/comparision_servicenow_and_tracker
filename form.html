<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Incident Data Form</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1a2e;
    --ink-soft: #4a4a6a;
    --ink-ghost: #9090b0;
    --paper: #fafaf8;
    --paper2: #f2f2ee;
    --rule: #e0e0d8;
    --accent: #4f46e5;
    --accent-light: #ede9fe;
    --danger: #dc2626;
    --success: #059669;
    --warning: #d97706;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--paper2);
    color: var(--ink);
    min-height: 100vh;
    padding: 0 0 80px;
  }

  /* ‚îÄ‚îÄ TOP BAND ‚îÄ‚îÄ */
  .top-band {
    background: var(--ink);
    color: white;
    padding: 18px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .brand {
    font-family: 'Instrument Serif', serif;
    font-size: 1.15rem;
    letter-spacing: 0.01em;
    opacity: 0.9;
  }

  .form-status-badge {
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 4px 12px;
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.7);
  }

  /* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
  .hero {
    background: var(--ink);
    padding: 40px 32px 60px;
    color: white;
    position: relative;
    overflow: hidden;
  }

  .hero::after {
    content: '';
    position: absolute;
    bottom: -1px; left: 0; right: 0;
    height: 40px;
    background: var(--paper2);
    clip-path: ellipse(55% 100% at 50% 100%);
  }

  .hero-label {
    font-size: 0.7rem;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: #a5b4fc;
    margin-bottom: 10px;
  }

  .hero-name {
    font-family: 'Instrument Serif', serif;
    font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 400;
    margin-bottom: 10px;
    line-height: 1.1;
  }

  .hero-meta {
    font-size: 0.82rem;
    color: rgba(255,255,255,0.5);
    display: flex;
    align-items: center;
    gap: 18px;
    flex-wrap: wrap;
  }

  .hero-meta span {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  /* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
  .progress-wrap {
    max-width: 760px;
    margin: -20px auto 0;
    padding: 0 24px;
    position: relative;
    z-index: 2;
  }

  .progress-card {
    background: white;
    border-radius: 12px;
    padding: 18px 22px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    border: 1px solid var(--rule);
    display: flex;
    align-items: center;
    gap: 18px;
  }

  .progress-info { flex: 1; }
  .progress-label { font-size: 0.72rem; letter-spacing: 0.06em; text-transform: uppercase; color: var(--ink-ghost); margin-bottom: 6px; }
  .progress-bar-track { height: 6px; background: var(--paper2); border-radius: 3px; overflow: hidden; }
  .progress-bar-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(--accent), #818cf8); transition: width 0.4s ease; }
  .progress-nums { font-family: 'Instrument Serif', serif; font-size: 1.5rem; color: var(--accent); white-space: nowrap; }

  /* ‚îÄ‚îÄ FORM AREA ‚îÄ‚îÄ */
  .form-wrap {
    max-width: 760px;
    margin: 28px auto 0;
    padding: 0 24px;
  }

  /* ‚îÄ‚îÄ INCIDENT CARD ‚îÄ‚îÄ */
  .incident-card {
    background: white;
    border-radius: 12px;
    border: 1px solid var(--rule);
    margin-bottom: 20px;
    overflow: hidden;
    transition: box-shadow 0.2s;
  }

  .incident-card.filled {
    border-color: #bbf7d0;
    box-shadow: 0 0 0 1px #bbf7d0;
  }

  .incident-head {
    padding: 16px 22px;
    background: var(--paper2);
    border-bottom: 1px solid var(--rule);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
  }

  .incident-sr {
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--accent);
    letter-spacing: 0.02em;
  }

  .incident-desc {
    font-size: 0.78rem;
    color: var(--ink-soft);
    margin-top: 3px;
    line-height: 1.4;
  }

  .field-count-badge {
    font-size: 0.68rem;
    padding: 3px 9px;
    border-radius: 12px;
    background: var(--accent-light);
    color: var(--accent);
    white-space: nowrap;
    flex-shrink: 0;
    font-weight: 500;
  }

  .incident-fields {
    padding: 18px 22px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }

  .field-full { grid-column: 1 / -1; }

  .field-group { display: flex; flex-direction: column; gap: 6px; }

  .field-label {
    font-size: 0.68rem;
    letter-spacing: 0.09em;
    text-transform: uppercase;
    color: var(--ink-ghost);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .req-star { color: var(--danger); }
  .opt-tag {
    font-size: 0.6rem;
    background: #f3e8ff;
    color: #7c3aed;
    padding: 1px 5px;
    border-radius: 3px;
    text-transform: none;
    letter-spacing: 0;
    font-weight: 400;
  }

  input[type="text"],
  input[type="date"],
  textarea,
  select {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    color: var(--ink);
    background: var(--paper);
    border: 1.5px solid var(--rule);
    border-radius: 7px;
    padding: 10px 13px;
    width: 100%;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    appearance: none;
    -webkit-appearance: none;
  }

  input:focus, textarea:focus, select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(79,70,229,0.1);
    background: white;
  }

  input.filled-field, textarea.filled-field, select.filled-field {
    border-color: #86efac;
    background: #f0fdf4;
  }

  textarea { resize: vertical; min-height: 80px; line-height: 1.5; }

  select { cursor: pointer; }

  /* custom select arrow */
  .select-wrap { position: relative; }
  .select-wrap::after {
    content: '‚ñæ';
    position: absolute;
    right: 12px; top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: var(--ink-ghost);
    font-size: 0.8rem;
  }

  /* ‚îÄ‚îÄ STICKY FOOTER ‚îÄ‚îÄ */
  .sticky-footer {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: white;
    border-top: 1px solid var(--rule);
    padding: 14px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    z-index: 100;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.06);
  }

  .footer-status {
    font-size: 0.8rem;
    color: var(--ink-soft);
  }

  .footer-status strong { color: var(--ink); }

  .btn-submit {
    font-family: 'DM Sans', sans-serif;
    font-size: 0.88rem;
    font-weight: 600;
    background: var(--accent);
    color: white;
    border: none;
    padding: 12px 28px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-submit:hover { background: #4338ca; transform: translateY(-1px); box-shadow: 0 4px 14px rgba(79,70,229,0.3); }
  .btn-submit:active { transform: translateY(0); }
  .btn-submit:disabled { background: #d1d5db; cursor: not-allowed; transform: none; box-shadow: none; }

  /* ‚îÄ‚îÄ SUCCESS STATE ‚îÄ‚îÄ */
  .success-screen {
    display: none;
    max-width: 520px;
    margin: 60px auto;
    padding: 0 24px;
    text-align: center;
  }

  .success-icon {
    width: 72px; height: 72px;
    background: #d1fae5;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 2rem;
    margin: 0 auto 24px;
    animation: popIn 0.4s cubic-bezier(0.34,1.56,0.64,1);
  }

  @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

  .success-title {
    font-family: 'Instrument Serif', serif;
    font-size: 2rem;
    margin-bottom: 10px;
    color: var(--ink);
  }

  .success-sub { font-size: 0.88rem; color: var(--ink-soft); line-height: 1.6; }

  /* ‚îÄ‚îÄ ERROR / LOADING STATES ‚îÄ‚îÄ */
  .error-screen, .loading-screen {
    max-width: 520px;
    margin: 80px auto;
    padding: 40px 24px;
    text-align: center;
  }

  .error-screen h2 { font-family: 'Instrument Serif', serif; font-size: 1.8rem; margin-bottom: 10px; }
  .error-screen p { color: var(--ink-soft); font-size: 0.88rem; }

  .spinner {
    width: 36px; height: 36px;
    border: 3px solid var(--rule);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 16px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ NOTICE ‚îÄ‚îÄ */
  .notice {
    background: #fffbeb;
    border: 1px solid #fde68a;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 0.78rem;
    color: #92400e;
    margin-bottom: 20px;
    display: flex;
    gap: 8px;
    align-items: flex-start;
  }

  @media (max-width: 600px) {
    .incident-fields { grid-template-columns: 1fr; }
    .field-full { grid-column: 1; }
    .hero { padding: 30px 20px 55px; }
    .progress-wrap, .form-wrap { padding: 0 14px; }
    .sticky-footer { flex-direction: column; gap: 10px; }
    .btn-submit { width: 100%; justify-content: center; }
  }
</style>
</head>
<body>

<div class="top-band">
  <div class="brand">Incident Tracker</div>
  <div class="form-status-badge" id="topBadge">Loading‚Ä¶</div>
</div>

<!-- Loading -->
<div class="loading-screen" id="loadingScreen">
  <div class="spinner"></div>
  <p style="color:var(--ink-soft);font-size:.88rem;">Loading your form‚Ä¶</p>
</div>

<!-- Error -->
<div class="error-screen" id="errorScreen" style="display:none;">
  <h2>Link Invalid</h2>
  <p>This form link doesn't contain the required data. Please ask your manager to regenerate and reshare your form link.</p>
</div>

<!-- Main form -->
<div id="mainContent" style="display:none;">
  <div class="hero">
    <div class="hero-label">Data Collection Request</div>
    <div class="hero-name" id="heroName">‚Äî</div>
    <div class="hero-meta">
      <span>üìã <span id="metaIncidents">0</span> incidents</span>
      <span>üìù <span id="metaFields">0</span> fields to fill</span>
      <span>üìÖ <span id="metaDate">‚Äî</span></span>
    </div>
  </div>

  <div class="progress-wrap">
    <div class="progress-card">
      <div class="progress-info">
        <div class="progress-label">Completion Progress</div>
        <div class="progress-bar-track">
          <div class="progress-bar-fill" id="progressFill" style="width:0%"></div>
        </div>
      </div>
      <div class="progress-nums"><span id="progressDone">0</span> / <span id="progressTotal">0</span></div>
    </div>
  </div>

  <div class="form-wrap">
    <div class="notice">
      ‚ö†Ô∏è Fields marked <strong>*</strong> are required. Fill every field accurately ‚Äî your data goes directly into the team tracker.
    </div>
    <div id="formContainer"></div>
  </div>
</div>

<!-- Success -->
<div class="success-screen" id="successScreen">
  <div class="success-icon">‚úì</div>
  <div class="success-title">All done!</div>
  <p class="success-sub" id="successSub"></p>
</div>

<!-- Sticky footer -->
<div class="sticky-footer" id="stickyFooter" style="display:none;">
  <div class="footer-status">
    <strong id="footerFilled">0</strong> of <strong id="footerTotal">0</strong> required fields filled
  </div>
  <button class="btn-submit" id="submitBtn" onclick="submitForm()" disabled>
    Submit Data ‚Üí
  </button>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG ‚Äî replace with your deployed Apps Script URL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyrlY6LjFxjqdQYHYTVosFBHSNhJpodnshUaFCd4FZTUHEQ6aG7Pvvm59ah9awTqkhv_g/exec";

// Field config
const OPTIONAL_FIELDS = ['Module','Close Date','Detail Description and Solution','SAAS Support SR (if any)'];
const FIELD_CONFIG = {
  'SR Open Date':    { type:'date' },
  'Assignment Date': { type:'date' },
  'Close Date':      { type:'date' },
  'Priority':        { type:'select', options:['1 - Critical','2 - High','3 - Medium','4 - Low'] },
  'Severity':        { type:'select', options:['1 - Critical','2 - High','3 - Medium','4 - Low'] },
  'Status':          { type:'select', options:['Open','In Progress','Pending','Resolved','Closed'] },
  'Type':            { type:'select', options:['Incident','Request','Change','Problem'] },
  'Incident Category': { type:'select', options:['Hardware','Software','Network','Access','Other'] },
  'Comments':        { type:'textarea' },
  'Description':     { type:'textarea' },
  'Detail Description and Solution': { type:'textarea' },
  'SAAS Support SR (if any)': { type:'text', placeholder:'e.g. SR123456 or N/A' },
};

const WIDE_FIELDS = ['Comments','Description','Detail Description and Solution','SAAS Support SR (if any)','CSU','Requested By','Current Owner'];

let formData = null;
let totalRequired = 0;
let filledRequired = 0;

// ‚îÄ‚îÄ Parse URL ‚îÄ‚îÄ
function init() {
  try {
    const params = new URLSearchParams(window.location.search);
    const encoded = params.get('data');
    if (!encoded) throw new Error('No data');

    formData = JSON.parse(decodeURIComponent(atob(encoded)));
    if (!formData.person || !formData.entries?.length) throw new Error('Invalid');

    renderForm();
  } catch(e) {
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('errorScreen').style.display = 'block';
  }
}

function renderForm() {
  document.getElementById('heroName').textContent = formData.person;
  document.getElementById('metaIncidents').textContent = formData.entries.length;
  document.getElementById('metaDate').textContent = new Date().toLocaleDateString('en-IN', { day:'numeric', month:'long', year:'numeric' });

  // Count total required fields
  formData.entries.forEach(entry => {
    entry.fields.forEach(f => {
      if (!OPTIONAL_FIELDS.includes(f)) totalRequired++;
    });
  });

  document.getElementById('metaFields').textContent = formData.entries.reduce((s,e)=>s+e.fields.length,0);
  document.getElementById('progressTotal').textContent = totalRequired;
  document.getElementById('footerTotal').textContent = totalRequired;

  const container = document.getElementById('formContainer');
  container.innerHTML = formData.entries.map((entry, ei) => {
    const fieldRows = entry.fields.map(field => {
      const cfg = FIELD_CONFIG[field] || { type:'text' };
      const isOpt = OPTIONAL_FIELDS.includes(field);
      const isWide = WIDE_FIELDS.includes(field) || cfg.type === 'textarea';
      const fid = `f_${ei}_${field.replace(/\W+/g,'_')}`;

      let inputHtml = '';
      if (cfg.type === 'select') {
        inputHtml = `<div class="select-wrap">
          <select id="${fid}" data-ei="${ei}" data-field="${field}" data-required="${!isOpt}" onchange="onFieldChange(this)">
            <option value="">‚Äî Select ‚Äî</option>
            ${cfg.options.map(o=>`<option>${o}</option>`).join('')}
          </select></div>`;
      } else if (cfg.type === 'textarea') {
        inputHtml = `<textarea id="${fid}" data-ei="${ei}" data-field="${field}" data-required="${!isOpt}"
          placeholder="Enter ${field.toLowerCase()}‚Ä¶" oninput="onFieldChange(this)"></textarea>`;
      } else if (cfg.type === 'date') {
        inputHtml = `<input type="date" id="${fid}" data-ei="${ei}" data-field="${field}" data-required="${!isOpt}" onchange="onFieldChange(this)">`;
      } else {
        inputHtml = `<input type="text" id="${fid}" data-ei="${ei}" data-field="${field}" data-required="${!isOpt}"
          placeholder="${cfg.placeholder||('Enter ' + field.toLowerCase() + '‚Ä¶')}" oninput="onFieldChange(this)">`;
      }

      return `<div class="field-group${isWide?' field-full':''}">
        <label class="field-label" for="${fid}">
          ${field}
          ${isOpt ? '<span class="opt-tag">optional</span>' : '<span class="req-star">*</span>'}
        </label>
        ${inputHtml}
      </div>`;
    }).join('');

    return `<div class="incident-card" id="card_${ei}">
      <div class="incident-head">
        <div>
          <div class="incident-sr">SR# ${entry.sr}</div>
          <div class="incident-desc">${entry.description}</div>
        </div>
        <div class="field-count-badge">${entry.fields.length} field${entry.fields.length>1?'s':''}</div>
      </div>
      <div class="incident-fields">${fieldRows}</div>
    </div>`;
  }).join('');

  document.getElementById('loadingScreen').style.display = 'none';
  document.getElementById('mainContent').style.display = 'block';
  document.getElementById('stickyFooter').style.display = 'flex';
  document.getElementById('topBadge').textContent = `${formData.entries.length} incidents`;
  updateProgress();
}

function onFieldChange(el) {
  const val = el.value.trim();
  el.classList.toggle('filled-field', val.length > 0);

  // Check if whole card is filled
  const ei = el.dataset.ei;
  const card = document.getElementById(`card_${ei}`);
  const allRequiredInCard = card.querySelectorAll('[data-required="true"]');
  const allFilled = Array.from(allRequiredInCard).every(i => i.value.trim());
  card.classList.toggle('filled', allFilled);

  updateProgress();
}

function updateProgress() {
  // Count filled required
  let filled = 0;
  document.querySelectorAll('[data-required="true"]').forEach(el => {
    if (el.value.trim()) filled++;
  });
  filledRequired = filled;

  const pct = totalRequired > 0 ? Math.round((filled / totalRequired) * 100) : 0;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressDone').textContent = filled;
  document.getElementById('footerFilled').textContent = filled;

  document.getElementById('submitBtn').disabled = (filled < totalRequired);
}

async function submitForm() {
  const btn = document.getElementById('submitBtn');

  // Validate
  let firstEmpty = null;
  document.querySelectorAll('[data-required="true"]').forEach(el => {
    if (!el.value.trim() && !firstEmpty) firstEmpty = el;
  });

  if (firstEmpty) {
    firstEmpty.scrollIntoView({ behavior:'smooth', block:'center' });
    firstEmpty.focus();
    firstEmpty.style.borderColor = 'var(--danger)';
    setTimeout(() => firstEmpty.style.borderColor = '', 2000);
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Submitting‚Ä¶';

  // Collect data
  const entries = formData.entries.map((entry, ei) => {
    const fields = {};
    entry.fields.forEach(field => {
      const fid = `f_${ei}_${field.replace(/\W+/g,'_')}`;
      const el = document.getElementById(fid);
      if (el && el.value.trim()) fields[field] = el.value.trim();
    });
    return { sr: entry.sr, description: entry.description, fields };
  });

  const payload = {
    type: 'batch',
    person: formData.person,
    submittedAt: new Date().toISOString(),
    entries
  };

  try {
    await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    // Show success (no-cors means we can't read response, assume success)
    document.getElementById('mainContent').style.display = 'none';
    document.getElementById('stickyFooter').style.display = 'none';
    document.getElementById('successScreen').style.display = 'block';
    document.getElementById('successSub').textContent =
      `Your data for ${entries.length} incident${entries.length>1?'s':''} has been submitted to the tracker. Your manager will review and update the sheet. You can close this tab.`;
    document.getElementById('topBadge').textContent = 'Submitted ‚úì';

  } catch(err) {
    btn.disabled = false;
    btn.textContent = 'Submit Data ‚Üí';
    alert('Submission failed. Please check your internet connection and try again.\n\nError: ' + err.message);
  }
}

init();
</script>
</body>
</html>
