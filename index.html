<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Incident Tracker ‚Äî Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0c0c14;
  --surface: #13131e;
  --surface2: #1a1a28;
  --surface3: #212133;
  --border: #252538;
  --border2: #2e2e48;
  --accent: #6366f1;
  --accent2: #818cf8;
  --success: #34d399;
  --danger: #f87171;
  --warning: #fbbf24;
  --purple: #c084fc;
  --text: #e2e2f0;
  --text-dim: #7070a0;
  --text-ghost: #404060;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family:'DM Sans',sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.layout { display:flex; min-height:100vh; }

.sidebar {
  width:220px;
  flex-shrink:0;
  background:var(--surface);
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  padding:24px 0;
  position:fixed;
  top:0; left:0; bottom:0;
  z-index:50;
}

.sidebar-logo {
  padding:0 20px 24px;
  border-bottom:1px solid var(--border);
  margin-bottom:16px;
}

.logo-text {
  font-family:'Instrument Serif',serif;
  font-size:1.1rem;
  color:var(--text);
  line-height:1.2;
}

.logo-sub { font-size:0.65rem; letter-spacing:.1em; text-transform:uppercase; color:var(--text-dim); font-family:'DM Mono',monospace; }

.nav-item {
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 20px;
  font-size:0.8rem;
  color:var(--text-dim);
  cursor:pointer;
  border-left:2px solid transparent;
  transition:all .15s;
  text-decoration:none;
}

.nav-item:hover { color:var(--text); background:rgba(255,255,255,.03); }
.nav-item.active { color:var(--accent2); border-left-color:var(--accent); background:rgba(99,102,241,.08); }
.nav-item .nav-icon { font-size:.9rem; width:18px; text-align:center; }

.sidebar-footer {
  margin-top:auto;
  padding:16px 20px;
  border-top:1px solid var(--border);
  font-size:0.68rem;
  color:var(--text-ghost);
  font-family:'DM Mono',monospace;
}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main { margin-left:220px; flex:1; }

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar {
  background:var(--surface);
  border-bottom:1px solid var(--border);
  padding:16px 32px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  position:sticky;
  top:0;
  z-index:40;
}

.topbar-title {
  font-family:'Instrument Serif',serif;
  font-size:1.2rem;
}

.topbar-right { display:flex; align-items:center; gap:12px; }

.config-url-wrap {
  display:flex;
  align-items:center;
  gap:8px;
  background:var(--surface2);
  border:1px solid var(--border2);
  border-radius:7px;
  padding:7px 12px;
}

.config-url-label { font-size:0.65rem; letter-spacing:.1em; text-transform:uppercase; color:var(--text-dim); white-space:nowrap; }

.config-url-input {
  font-family:'DM Mono',monospace;
  font-size:0.72rem;
  background:transparent;
  border:none;
  outline:none;
  color:var(--accent2);
  width:300px;
}

.config-url-input::placeholder { color:var(--text-ghost); }

.badge-admin {
  font-size:0.65rem;
  letter-spacing:.08em;
  text-transform:uppercase;
  padding:4px 10px;
  border-radius:20px;
  background:rgba(99,102,241,.15);
  color:var(--accent2);
  border:1px solid rgba(99,102,241,.2);
}

/* ‚îÄ‚îÄ PAGE CONTENT ‚îÄ‚îÄ */
.page { display:none; padding:32px; }
.page.active { display:block; }

/* ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ */
.upload-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
  margin-bottom:24px;
}

.upload-card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:12px;
  padding:24px;
  position:relative;
  overflow:hidden;
}

.upload-card::before {
  content:'';
  position:absolute;
  top:0;left:0;right:0;
  height:2px;
}

.upload-card.sn::before { background:linear-gradient(90deg,var(--accent),transparent); }
.upload-card.tr::before { background:linear-gradient(90deg,#f472b6,transparent); }

.upload-chip {
  font-size:.65rem;
  letter-spacing:.1em;
  text-transform:uppercase;
  margin-bottom:8px;
  font-family:'DM Mono',monospace;
}

.upload-card.sn .upload-chip { color:var(--accent2); }
.upload-card.tr .upload-chip { color:#f9a8d4; }

.upload-card h3 { font-size:.9rem; font-weight:600; margin-bottom:14px; }

.drop-zone {
  border:1.5px dashed var(--border2);
  border-radius:8px;
  padding:24px;
  text-align:center;
  cursor:pointer;
  transition:all .2s;
  position:relative;
}

.drop-zone:hover { border-color:var(--accent); background:rgba(99,102,241,.04); }

.drop-zone input {
  position:absolute;inset:0;
  opacity:0;cursor:pointer;width:100%;height:100%;
}

.drop-icon { font-size:1.6rem; margin-bottom:6px; }
.drop-text { font-size:.78rem; color:var(--text-dim); }
.drop-fname { font-size:.72rem; color:var(--success); margin-top:8px; display:none; font-family:'DM Mono',monospace; }

/* ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ */
.controls-bar {
  display:flex;
  align-items:center;
  gap:14px;
  margin-bottom:32px;
}

.toggle-row {
  flex:1;
  display:flex;
  align-items:center;
  gap:10px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:8px;
  padding:10px 16px;
  cursor:pointer;
  user-select:none;
}

.toggle-track {
  width:38px;height:21px;
  background:var(--border2);
  border-radius:12px;
  position:relative;
  flex-shrink:0;
  transition:background .2s;
}

.toggle-track.on { background:var(--accent); }
.toggle-thumb {
  width:15px;height:15px;
  background:white;
  border-radius:50%;
  position:absolute;
  top:3px;left:3px;
  transition:left .2s;
  box-shadow:0 1px 4px rgba(0,0,0,.4);
}
.toggle-track.on .toggle-thumb { left:20px; }
.toggle-label { font-size:.75rem; color:var(--text-dim); }
.toggle-label em { color:var(--purple); font-style:normal; }

.btn { font-family:'DM Sans',sans-serif; font-size:.82rem; font-weight:600; padding:10px 22px; border-radius:8px; cursor:pointer; border:none; transition:all .2s; }
.btn-primary { background:var(--accent); color:white; }
.btn-primary:hover { background:#4f46e5; transform:translateY(-1px); }
.btn-primary:disabled { background:var(--border2); color:var(--text-ghost); cursor:not-allowed; transform:none; }
.btn-outline { background:transparent; color:var(--text-dim); border:1px solid var(--border2); }
.btn-outline:hover { color:var(--text); border-color:var(--text-dim); }
.btn-success { background:rgba(52,211,153,.1); color:var(--success); border:1px solid rgba(52,211,153,.25); }
.btn-success:hover { background:rgba(52,211,153,.2); }

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats-grid {
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:14px;
  margin-bottom:28px;
}

.stat {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:10px;
  padding:18px 16px;
  text-align:center;
}

.stat-n { font-family:'Instrument Serif',serif; font-size:2.2rem; margin-bottom:4px; }
.stat-l { font-size:.62rem; letter-spacing:.08em; text-transform:uppercase; color:var(--text-dim); }

/* ‚îÄ‚îÄ FORM GEN PANEL ‚îÄ‚îÄ */
.formgen-panel {
  background:linear-gradient(135deg,rgba(99,102,241,.08),rgba(192,132,252,.05));
  border:1px solid rgba(99,102,241,.2);
  border-radius:12px;
  padding:24px;
  margin-bottom:28px;
}

.formgen-panel h2 {
  font-family:'Instrument Serif',serif;
  font-size:1.2rem;
  font-weight:400;
  margin-bottom:4px;
}

.formgen-panel p { font-size:.78rem; color:var(--text-dim); margin-bottom:20px; }

.person-cards {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:12px;
  margin-bottom:16px;
}

.person-card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:10px;
  padding:16px;
  cursor:pointer;
  transition:all .2s;
  text-align:center;
}

.person-card:hover {
  border-color:var(--accent);
  background:rgba(99,102,241,.06);
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(0,0,0,.3);
}

.p-avatar {
  width:42px;height:42px;
  border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-family:'Instrument Serif',serif;
  font-size:1rem;
  margin:0 auto 10px;
  color:white;
}

.p-name { font-size:.82rem; font-weight:600; margin-bottom:3px; }
.p-stats { font-size:.68rem; color:var(--text-dim); }
.p-stats strong { color:var(--danger); }

.formgen-actions { display:flex; gap:10px; flex-wrap:wrap; }

/* ‚îÄ‚îÄ SECTION ACCORDION ‚îÄ‚îÄ */
.section {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:12px;
  margin-bottom:16px;
  overflow:hidden;
}

.sec-head {
  padding:16px 22px;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:pointer;
  user-select:none;
}

.sec-head:hover { background:rgba(255,255,255,.02); }

.sec-title {
  display:flex;
  align-items:center;
  gap:10px;
  font-size:.82rem;
  font-weight:600;
}

.dot { width:8px;height:8px;border-radius:50%;flex-shrink:0; }
.dot-red { background:var(--danger);box-shadow:0 0 8px var(--danger); }
.dot-yellow { background:var(--warning);box-shadow:0 0 8px var(--warning); }
.dot-blue { background:#60a5fa;box-shadow:0 0 8px #60a5fa; }
.dot-purple { background:var(--purple);box-shadow:0 0 8px var(--purple); }

.pill {
  font-size:.66rem;
  padding:3px 9px;
  border-radius:14px;
  font-weight:500;
}

.pill-red   { background:rgba(248,113,113,.15);color:var(--danger);border:1px solid rgba(248,113,113,.25); }
.pill-yellow{ background:rgba(251,191,36,.1);color:var(--warning);border:1px solid rgba(251,191,36,.2); }
.pill-blue  { background:rgba(96,165,250,.1);color:#60a5fa;border:1px solid rgba(96,165,250,.2); }
.pill-purple{ background:rgba(192,132,252,.1);color:var(--purple);border:1px solid rgba(192,132,252,.2); }

.sec-chev { color:var(--text-dim);transition:transform .2s;font-size:.75rem; }
.sec-body { display:none;padding:20px 22px; }
.sec-body.open { display:block; }

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
table { width:100%;border-collapse:collapse;font-size:.78rem; }
th {
  font-family:'DM Mono',monospace;
  font-size:.6rem;
  letter-spacing:.1em;
  text-transform:uppercase;
  color:var(--text-dim);
  padding:8px 12px;
  text-align:left;
  border-bottom:1px solid var(--border);
}
td {
  padding:10px 12px;
  border-bottom:1px solid rgba(37,37,56,.6);
  vertical-align:top;
}
tr:last-child td { border-bottom:none; }
tr:hover td { background:rgba(255,255,255,.015); }

.p-high { color:var(--danger);font-weight:500; }
.p-med  { color:var(--warning);font-weight:500; }
.p-low  { color:var(--success);font-weight:500; }

.tag {
  display:inline-block;
  font-size:.62rem;
  padding:2px 6px;
  border-radius:4px;
  margin:2px 2px 2px 0;
  background:rgba(248,113,113,.1);
  color:var(--danger);
  border:1px solid rgba(248,113,113,.2);
  font-family:'DM Mono',monospace;
}

.empty { text-align:center;padding:36px;color:var(--text-dim);font-size:.82rem; }
.empty .ck { color:var(--success);font-size:1.4rem;margin-bottom:6px; }

/* ‚îÄ‚îÄ PERSON BLOCK ‚îÄ‚îÄ */
.person-block {
  background:var(--surface2);
  border:1px solid var(--border);
  border-radius:8px;
  margin-bottom:14px;
  overflow:hidden;
}

.person-head {
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.person-head-name { font-weight:600;font-size:.82rem; }

/* ‚îÄ‚îÄ RESPONSES PAGE ‚îÄ‚îÄ */
.responses-toolbar {
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:20px;
  flex-wrap:wrap;
}

.response-count {
  font-family:'Instrument Serif',serif;
  font-size:2rem;
  color:var(--success);
}

.response-label { font-size:.7rem; color:var(--text-dim); letter-spacing:.06em; text-transform:uppercase; }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.overlay {
  position:fixed;inset:0;
  background:rgba(0,0,0,.7);
  backdrop-filter:blur(6px);
  z-index:200;
  display:none;
  align-items:center;
  justify-content:center;
  padding:20px;
}

.overlay.open { display:flex; }

.modal {
  background:var(--surface);
  border:1px solid var(--border2);
  border-radius:16px;
  width:100%;
  max-width:680px;
  max-height:88vh;
  overflow-y:auto;
  animation:rise .25s ease;
}

@keyframes rise { from{opacity:0;transform:translateY(24px)} to{opacity:1;transform:translateY(0)} }

.modal-head {
  padding:22px 26px 18px;
  border-bottom:1px solid var(--border);
  position:sticky;top:0;background:var(--surface);z-index:1;
  display:flex;align-items:flex-start;justify-content:space-between;gap:16px;
}

.modal-title { font-family:'Instrument Serif',serif; font-size:1.1rem; }
.modal-sub { font-size:.72rem;color:var(--text-dim);margin-top:3px; }
.modal-x { background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:1.1rem;padding:4px; }
.modal-x:hover { color:var(--text); }
.modal-body { padding:22px 26px; }
.modal-foot { padding:14px 26px 22px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap; }

/* ‚îÄ‚îÄ SHARE LINK BOX ‚îÄ‚îÄ */
.share-box {
  background:var(--surface2);
  border:1px solid var(--border2);
  border-radius:8px;
  padding:14px 16px;
  margin-bottom:16px;
}

.share-label { font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);margin-bottom:8px;font-family:'DM Mono',monospace; }

.share-link-row { display:flex;gap:8px;align-items:center; }

.share-link-input {
  flex:1;
  font-family:'DM Mono',monospace;
  font-size:.7rem;
  background:var(--surface3);
  border:1px solid var(--border2);
  border-radius:6px;
  padding:9px 12px;
  color:var(--accent2);
  outline:none;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.btn-copy-link {
  font-family:'DM Sans',sans-serif;
  font-size:.75rem;
  font-weight:600;
  background:rgba(99,102,241,.15);
  color:var(--accent2);
  border:1px solid rgba(99,102,241,.25);
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
  transition:all .15s;
  white-space:nowrap;
}
.btn-copy-link:hover { background:rgba(99,102,241,.25); }

/* ‚îÄ‚îÄ SUMMARY BAR ‚îÄ‚îÄ */
.bar-track { height:4px;background:var(--border2);border-radius:2px;overflow:hidden;margin-top:3px; }
.bar-fill { height:100%;border-radius:2px;background:linear-gradient(90deg,var(--danger),#f472b6); }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  position:fixed;bottom:28px;right:28px;
  background:var(--surface2);
  border:1px solid var(--border2);
  border-radius:8px;
  padding:12px 18px;
  font-size:.78rem;
  z-index:9999;
  animation:toastIn .25s ease;
  pointer-events:none;
}
@keyframes toastIn { from{opacity:0;transform:translateY(8px)} }

/* ‚îÄ‚îÄ SETUP GUIDE ‚îÄ‚îÄ */
.setup-card {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:12px;
  padding:28px;
  max-width:740px;
}

.setup-step {
  display:flex;
  gap:16px;
  margin-bottom:24px;
  padding-bottom:24px;
  border-bottom:1px solid var(--border);
}

.setup-step:last-child { border-bottom:none;margin-bottom:0;padding-bottom:0; }

.step-num {
  width:32px;height:32px;
  background:rgba(99,102,241,.15);
  border:1px solid rgba(99,102,241,.3);
  border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-family:'Instrument Serif',serif;
  font-size:1rem;
  color:var(--accent2);
  flex-shrink:0;
}

.step-content h3 { font-size:.88rem;font-weight:600;margin-bottom:6px; }
.step-content p { font-size:.78rem;color:var(--text-dim);line-height:1.6; }
.step-content code {
  font-family:'DM Mono',monospace;
  font-size:.72rem;
  background:var(--surface2);
  border:1px solid var(--border2);
  border-radius:4px;
  padding:2px 7px;
  color:var(--accent2);
}

.step-content .url-display {
  font-family:'DM Mono',monospace;
  font-size:.7rem;
  background:var(--surface2);
  border:1px solid var(--border2);
  border-radius:6px;
  padding:10px 14px;
  color:var(--success);
  margin-top:8px;
  word-break:break-all;
}
</style>
</head>
<body>

<div class="layout">

<!-- ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-text">Incident<br>Tracker</div>
    <div class="logo-sub" style="margin-top:4px;">Admin Console</div>
  </div>

  <nav>
    <div class="nav-item active" onclick="showPage('analyze')">
      <span class="nav-icon">üîç</span> Analyze
    </div>
    <div class="nav-item" onclick="showPage('responses')">
      <span class="nav-icon">üì•</span> Responses
    </div>
    <div class="nav-item" onclick="showPage('setup')">
      <span class="nav-icon">‚öôÔ∏è</span> Setup Guide
    </div>
  </nav>

  <div class="sidebar-footer">
    GitHub Pages<br>Static Host
  </div>
</aside>

<!-- ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ -->
<div class="main">

<!-- Topbar -->
<div class="topbar">
  <div class="topbar-title" id="pageTitle">Analyze Sheets</div>
  <div class="topbar-right">
    <div class="config-url-wrap">
      <div class="config-url-label">Apps Script URL</div>
      <input class="config-url-input" id="appsScriptUrl" type="text"
        placeholder="Paste your deployed Web App URL‚Ä¶"
        oninput="saveConfig()">
    </div>
    <div class="badge-admin">Admin</div>
  </div>
</div>

<!-- ‚ïê‚ïê PAGE: ANALYZE ‚ïê‚ïê -->
<div class="page active" id="page-analyze">

  <div class="upload-grid">
    <div class="upload-card sn">
      <div class="upload-chip">Source of Truth</div>
      <h3>ServiceNow Sheet</h3>
      <div class="drop-zone">
        <input type="file" accept=".xlsx" onchange="handleFile('sn',this)">
        <div class="drop-icon">üìã</div>
        <div class="drop-text">Drop .xlsx or click to browse</div>
        <div class="drop-fname" id="snName"></div>
      </div>
    </div>

    <div class="upload-card tr">
      <div class="upload-chip">Team Updates</div>
      <h3>Tracker Sheet</h3>
      <div class="drop-zone">
        <input type="file" accept=".xlsx" onchange="handleFile('tr',this)">
        <div class="drop-icon">üìù</div>
        <div class="drop-text">Drop .xlsx or click to browse</div>
        <div class="drop-fname" id="trName"></div>
      </div>
    </div>
  </div>

  <div class="controls-bar">
    <div class="toggle-row" onclick="toggleOpt()">
      <div class="toggle-track" id="togTrack"><div class="toggle-thumb"></div></div>
      <span class="toggle-label">Include optional columns: <em>Module, Close Date, Detail Description & Solution, SAAS Support SR</em></span>
    </div>
    <button class="btn btn-primary" id="analyzeBtn" onclick="runAnalysis()" disabled>üîç Analyze</button>
  </div>

  <!-- Results -->
  <div id="results" style="display:none;">

    <div class="stats-grid">
      <div class="stat"><div class="stat-n" id="sn1" style="color:var(--danger)">0</div><div class="stat-l">Missing in Tracker</div></div>
      <div class="stat"><div class="stat-n" id="sn2" style="color:var(--warning)">0</div><div class="stat-l">Tracker Only</div></div>
      <div class="stat"><div class="stat-n" id="sn3" style="color:var(--warning)">0</div><div class="stat-l">Priority Mismatches</div></div>
      <div class="stat"><div class="stat-n" id="sn4" style="color:#60a5fa">0</div><div class="stat-l">Incomplete Entries</div></div>
      <div class="stat"><div class="stat-n" id="sn5" style="color:var(--purple)">0</div><div class="stat-l">Duplicates</div></div>
    </div>

    <!-- Form Generator -->
    <div class="formgen-panel" id="formgenPanel" style="display:none;">
      <h2>üì§ Send Data Collection Forms</h2>
      <p>Click a team member to generate a shareable link. They open the link in their browser, fill their missing fields, and submit ‚Äî data goes straight to your Google Sheet.</p>
      <div class="person-cards" id="personCards"></div>
      <div class="formgen-actions">
        <button class="btn btn-outline" onclick="copyAllLinks()">üìã Copy All Links</button>
        <button class="btn btn-success" onclick="showPage('responses')">üì• View Responses ‚Üí</button>
      </div>
    </div>

    <!-- Sections -->
    <div class="section">
      <div class="sec-head" onclick="toggleSec(this)">
        <div class="sec-title"><div class="dot dot-red"></div>Missing in Tracker<span class="pill pill-red" id="c1">0</span></div>
        <div class="sec-chev">‚ñº</div>
      </div>
      <div class="sec-body"><div id="t1"></div></div>
    </div>

    <div class="section">
      <div class="sec-head" onclick="toggleSec(this)">
        <div class="sec-title"><div class="dot dot-yellow"></div>In Tracker Only (Not in ServiceNow)<span class="pill pill-yellow" id="c2">0</span></div>
        <div class="sec-chev">‚ñº</div>
      </div>
      <div class="sec-body"><div id="t2"></div></div>
    </div>

    <div class="section">
      <div class="sec-head" onclick="toggleSec(this)">
        <div class="sec-title"><div class="dot dot-yellow"></div>Priority Mismatches<span class="pill pill-yellow" id="c3">0</span></div>
        <div class="sec-chev">‚ñº</div>
      </div>
      <div class="sec-body"><div id="t3"></div></div>
    </div>

    <div class="section">
      <div class="sec-head" onclick="toggleSec(this)">
        <div class="sec-title"><div class="dot dot-blue"></div>Missing Fields Summary by Team Member<span class="pill pill-blue" id="c4">0</span></div>
        <div class="sec-chev">‚ñº</div>
      </div>
      <div class="sec-body open"><div id="t4"></div></div>
    </div>

    <div class="section">
      <div class="sec-head" onclick="toggleSec(this)">
        <div class="sec-title"><div class="dot dot-blue"></div>Incomplete Entries by Team Member (Detailed)<span class="pill pill-blue" id="c5">0</span></div>
        <div class="sec-chev">‚ñº</div>
      </div>
      <div class="sec-body"><div id="t5"></div></div>
    </div>

    <div class="section">
      <div class="sec-head" onclick="toggleSec(this)">
        <div class="sec-title"><div class="dot dot-purple"></div>Duplicate Entries in Tracker<span class="pill pill-purple" id="c6">0</span></div>
        <div class="sec-chev">‚ñº</div>
      </div>
      <div class="sec-body"><div id="t6"></div></div>
    </div>

  </div><!-- /results -->
</div><!-- /page-analyze -->

<!-- ‚ïê‚ïê PAGE: RESPONSES ‚ïê‚ïê -->
<div class="page" id="page-responses" style="padding:32px;">
  <div class="responses-toolbar">
    <div>
      <div class="response-count" id="respCount">0</div>
      <div class="response-label">Total Responses Received</div>
    </div>
    <button class="btn btn-outline" onclick="loadResponses()">‚Üª Refresh</button>
    <button class="btn btn-success" onclick="exportResponsesToCSV()">‚¨á Export CSV</button>
  </div>
  <div id="responsesTable">
    <div class="empty"><div class="ck">üì•</div>Click Refresh to load responses from Google Sheets</div>
  </div>
</div>

<!-- ‚ïê‚ïê PAGE: SETUP ‚ïê‚ïê -->
<div class="page" id="page-setup" style="padding:32px;">
  <div class="setup-card">
    <h2 style="font-family:'Instrument Serif',serif;font-size:1.5rem;font-weight:400;margin-bottom:6px;">One-Time Setup Guide</h2>
    <p style="color:var(--text-dim);font-size:.8rem;margin-bottom:28px;">Follow these steps once. After that, everything runs automatically.</p>

    <div class="setup-step">
      <div class="step-num">1</div>
      <div class="step-content">
        <h3>Create a Google Sheet</h3>
        <p>Go to <a href="https://sheets.google.com" target="_blank" style="color:var(--accent2)">sheets.google.com</a> and create a new blank spreadsheet. Name it something like <code>Incident Tracker Responses</code>. Leave it open.</p>
      </div>
    </div>

    <div class="setup-step">
      <div class="step-num">2</div>
      <div class="step-content">
        <h3>Open Apps Script</h3>
        <p>In your Google Sheet, go to <strong>Extensions ‚Üí Apps Script</strong>. Delete all existing code in the editor. Paste the entire contents of <code>Code.gs</code> (included in your GitHub repo). Click <strong>Save</strong> (üíæ icon).</p>
      </div>
    </div>

    <div class="setup-step">
      <div class="step-num">3</div>
      <div class="step-content">
        <h3>Deploy as Web App</h3>
        <p>Click <strong>Deploy ‚Üí New deployment</strong>. Set type to <code>Web app</code>. Set <em>Execute as</em> to <code>Me</code>. Set <em>Who has access</em> to <code>Anyone</code>. Click <strong>Deploy</strong> and authorize when prompted. Copy the Web App URL.</p>
      </div>
    </div>

    <div class="setup-step">
      <div class="step-num">4</div>
      <div class="step-content">
        <h3>Paste the URL in this tool</h3>
        <p>Paste the Web App URL into the <strong>Apps Script URL</strong> field at the top of this page. It looks like:</p>
        <div class="url-display">https://script.google.com/macros/s/AKfycb.../exec</div>
        <p style="margin-top:8px;">The URL is saved in your browser ‚Äî you only need to do this once.</p>
      </div>
    </div>

    <div class="setup-step">
      <div class="step-num">5</div>
      <div class="step-content">
        <h3>Push to GitHub &amp; enable Pages</h3>
        <p>Push <code>index.html</code>, <code>form.html</code>, and <code>Code.gs</code> to your GitHub repo. Go to <strong>Settings ‚Üí Pages</strong>, set source to <code>main</code> branch, root folder. Your tool is now live at <code>https://yourusername.github.io/yourrepo/</code>.</p>
      </div>
    </div>

    <div class="setup-step">
      <div class="step-num">6</div>
      <div class="step-content">
        <h3>Done! Your workflow</h3>
        <p>
          1. Upload both Excel files on the <strong>Analyze</strong> page.<br>
          2. Click a team member's card ‚Üí copy their link ‚Üí send it via WhatsApp / Email / Teams.<br>
          3. They open the link, fill missing fields, hit Submit.<br>
          4. Go to <strong>Responses</strong> page ‚Üí click Refresh ‚Üí see all collected data ‚Üí Export CSV to update your tracker.
        </p>
      </div>
    </div>
  </div>
</div>

</div><!-- /main -->
</div><!-- /layout -->

<!-- ‚îÄ‚îÄ LINK MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="linkModal">
  <div class="modal">
    <div class="modal-head">
      <div>
        <div class="modal-title" id="modalTitle">Share Form Link</div>
        <div class="modal-sub" id="modalSub"></div>
      </div>
      <button class="modal-x" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="share-box">
        <div class="share-label">Shareable Link ‚Äî Send this to the team member</div>
        <div class="share-link-row">
          <input class="share-link-input" id="shareLink" readonly>
          <button class="btn-copy-link" onclick="copyShareLink()">Copy Link</button>
        </div>
      </div>
      <div style="font-size:.75rem;color:var(--text-dim);line-height:1.7;">
        üì± Send via <strong>WhatsApp, Email, Teams, or Slack</strong>.<br>
        üîí The link contains only their missing field data ‚Äî no other incidents.<br>
        ‚úÖ When they submit, data goes directly to your Google Sheet.
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal()">Close</button>
      <button class="btn btn-primary" onclick="copyShareLink()">üìã Copy Link</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ö†Ô∏è Replace with your GitHub Pages URL (no trailing slash)
const GITHUB_PAGES_BASE = "https://harshitkalraoracle-dot.github.io/comparision_servicenow_and_tracker";

const REQUIRED = ['SR#','SR Open Date','Assignment Date','Incident Category','Type','CSU','Priority','Severity','Description','Requested By','Worked By','Status','Current Owner','Comments'];
const OPTIONAL = ['Module','Close Date','Detail Description and Solution','SAAS Support SR (if any)'];

const FIELD_CONFIG = {
  'SR Open Date':    { type:'date' },
  'Assignment Date': { type:'date' },
  'Close Date':      { type:'date' },
  'Priority':        { type:'select', options:['1 - Critical','2 - High','3 - Medium','4 - Low'] },
  'Severity':        { type:'select', options:['1 - Critical','2 - High','3 - Medium','4 - Low'] },
  'Status':          { type:'select', options:['Open','In Progress','Pending','Resolved','Closed'] },
  'Type':            { type:'select', options:['Incident','Request','Change','Problem'] },
  'Incident Category': { type:'select', options:['Hardware','Software','Network','Access','Other'] },
  'Comments':        { type:'textarea' },
  'Description':     { type:'textarea' },
  'Detail Description and Solution': { type:'textarea' },
  'SAAS Support SR (if any)': { type:'text', placeholder:'e.g. SR123456 or N/A' },
};

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let snData = null, trData = null;
let checkOpt = false;
let allIncomplete = {};
let currentPerson = null;
const AVATAR_COLORS = ['#6366f1','#ec4899','#f59e0b','#10b981','#3b82f6','#8b5cf6','#ef4444','#06b6d4'];

// ‚îÄ‚îÄ Config persistence ‚îÄ‚îÄ
function saveConfig() {
  const url = document.getElementById('appsScriptUrl').value.trim();
  if (url) localStorage.setItem('appsScriptUrl', url);
}

function loadConfig() {
  const saved = localStorage.getItem('appsScriptUrl');
  if (saved) document.getElementById('appsScriptUrl').value = saved;
}

function getAppsScriptUrl() { return document.getElementById('appsScriptUrl').value.trim(); }

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  event?.currentTarget?.classList.add('active');

  const titles = { analyze:'Analyze Sheets', responses:'Responses', setup:'Setup Guide' };
  document.getElementById('pageTitle').textContent = titles[id] || id;
}

// ‚îÄ‚îÄ File Handling ‚îÄ‚îÄ
function handleFile(type, input) {
  const file = input.files[0];
  if (!file) return;
  if (!file.name.endsWith('.xlsx')) { toast('‚ö†Ô∏è Only .xlsx files'); input.value=''; return; }
  const nameEl = document.getElementById(type === 'sn' ? 'snName' : 'trName');
  nameEl.textContent = '‚úì ' + file.name;
  nameEl.style.display = 'block';
  const sn = document.getElementById('snName').style.display !== 'none';
  const tr = document.getElementById('trName').style.display !== 'none';
  document.getElementById('analyzeBtn').disabled = !(sn && tr);
}

function readXLSX(file) {
  return new Promise((res,rej) => {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const wb = XLSX.read(new Uint8Array(e.target.result), { type:'array' });
        res(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { raw:false, defval:'' }));
      } catch(err) { rej(err); }
    };
    reader.onerror = rej;
    reader.readAsArrayBuffer(file);
  });
}

function toggleOpt() {
  checkOpt = !checkOpt;
  document.getElementById('togTrack').classList.toggle('on', checkOpt);
}

// ‚îÄ‚îÄ Analysis ‚îÄ‚îÄ
async function runAnalysis() {
  const btn = document.getElementById('analyzeBtn');
  btn.disabled = true; btn.textContent = '‚è≥ Analyzing‚Ä¶';
  try {
    snData  = await readXLSX(document.querySelectorAll('.drop-zone input')[0].files[0]);
    trData  = await readXLSX(document.querySelectorAll('.drop-zone input')[1].files[0]);
    analyze();
    document.getElementById('results').style.display = 'block';
    // Open all sections
    document.querySelectorAll('.sec-body').forEach(b => b.classList.add('open'));
    document.querySelectorAll('.sec-chev').forEach(c => c.style.transform = 'rotate(180deg)');
    btn.textContent = '‚úì Done';
    setTimeout(() => { btn.textContent = 'üîç Analyze'; btn.disabled = false; }, 2000);
  } catch(e) {
    alert('Error: ' + e.message);
    btn.textContent = 'üîç Analyze'; btn.disabled = false;
  }
}

function analyze() {
  const trMap = new Map(), snMap = new Map();
  trData.forEach(r => { const s = (r['SR#']||'').trim(); if(s) trMap.set(s,r); });
  snData.forEach(r => { const s = (r['SR#']||r['Number']||'').trim(); if(s) snMap.set(s,r); });

  const missing = snData.filter(r => { const s=(r['SR#']||r['Number']||'').trim(); return s && !trMap.has(s); });
  const trackerOnly = trData.filter(r => { const s=(r['SR#']||'').trim(); return s && !snMap.has(s); });

  const mismatches = [];
  snData.forEach(r => {
    const s = (r['SR#']||r['Number']||'').trim();
    if (s && trMap.has(s)) {
      const tr = trMap.get(s);
      const sp = (r['Priority']||'').trim(), tp = (tr['Priority']||'').trim();
      if (sp && tp && sp !== tp) mismatches.push({ sr:s, snP:sp, trP:tp, desc:r['Description']||'', by:tr['Worked By']||'' });
    }
  });

  const cols = checkOpt ? [...REQUIRED,...OPTIONAL] : [...REQUIRED];
  allIncomplete = {};
  trData.forEach(r => {
    const person = (r['Worked By']||'').trim() || 'Unassigned';
    const empty = cols.filter(f => !(r[f]||'').trim());
    if (empty.length) {
      if (!allIncomplete[person]) allIncomplete[person] = [];
      allIncomplete[person].push({ sr:r['SR#']||'N/A', fields:empty, description:r['Description']||'N/A', rowData:r });
    }
  });

  const srOcc = {};
  trData.forEach((r,i) => {
    const s = (r['SR#']||'').trim();
    if (s) { if(!srOcc[s]) srOcc[s]=[]; srOcc[s].push({row:r,idx:i+2}); }
  });
  const dups = {};
  Object.keys(srOcc).forEach(s => { if(srOcc[s].length > 1) dups[s] = srOcc[s]; });

  const totalInc = Object.values(allIncomplete).reduce((s,a)=>s+a.length,0);
  document.getElementById('sn1').textContent = missing.length;
  document.getElementById('sn2').textContent = trackerOnly.length;
  document.getElementById('sn3').textContent = mismatches.length;
  document.getElementById('sn4').textContent = totalInc;
  document.getElementById('sn5').textContent = Object.keys(dups).length;

  renderMissing(missing);
  renderTrackerOnly(trackerOnly);
  renderMismatches(mismatches);
  renderSummary(allIncomplete, trData);
  renderDetailed(allIncomplete);
  renderDups(dups);
  buildFormGen(allIncomplete, trData);
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function pc(p) {
  const s = p.toString().toLowerCase();
  if (s.includes('1')||s.includes('critical')||s.includes('high')) return 'p-high';
  if (s.includes('2')||s.includes('medium')) return 'p-med';
  if (s.includes('3')||s.includes('low')) return 'p-low';
  return '';
}

function empty(msg) { return `<div class="empty"><div class="ck">‚úì</div>${msg}</div>`; }

function toggleSec(head) {
  const body = head.nextElementSibling;
  const chev = head.querySelector('.sec-chev');
  body.classList.toggle('open');
  chev.style.transform = body.classList.contains('open') ? 'rotate(180deg)' : '';
}

// ‚îÄ‚îÄ Render functions ‚îÄ‚îÄ
function renderMissing(data) {
  document.getElementById('c1').textContent = data.length;
  const c = document.getElementById('t1');
  if (!data.length) { c.innerHTML = empty('All ServiceNow incidents are tracked'); return; }
  c.innerHTML = `<table><thead><tr><th>SR#</th><th>Priority</th><th>Description</th><th>Open Date</th><th>Status</th></tr></thead><tbody>
    ${data.map(r=>`<tr><td><strong>${r['SR#']||r['Number']||'N/A'}</strong></td>
    <td class="${pc(r['Priority']||'')}">${r['Priority']||'N/A'}</td>
    <td>${r['Description']||'N/A'}</td><td>${r['SR Open Date']||r['Open Date']||'N/A'}</td>
    <td>${r['Status']||'N/A'}</td></tr>`).join('')}
  </tbody></table>`;
}

function renderTrackerOnly(data) {
  document.getElementById('c2').textContent = data.length;
  const c = document.getElementById('t2');
  if (!data.length) { c.innerHTML = empty('All tracker incidents exist in ServiceNow'); return; }
  c.innerHTML = `<table><thead><tr><th>SR#</th><th>Description</th><th>Worked By</th><th>Priority</th><th>Status</th></tr></thead><tbody>
    ${data.map(r=>`<tr><td><strong>${r['SR#']||'N/A'}</strong></td>
    <td>${r['Description']||'N/A'}</td><td>${r['Worked By']||'N/A'}</td>
    <td class="${pc(r['Priority']||'')}">${r['Priority']||'N/A'}</td>
    <td>${r['Status']||'N/A'}</td></tr>`).join('')}
  </tbody></table>`;
}

function renderMismatches(data) {
  document.getElementById('c3').textContent = data.length;
  const c = document.getElementById('t3');
  if (!data.length) { c.innerHTML = empty('All priorities match'); return; }
  c.innerHTML = `<table><thead><tr><th>SR#</th><th>ServiceNow Priority</th><th>Tracker Priority</th><th>Worked By</th><th>Description</th></tr></thead><tbody>
    ${data.map(m=>`<tr><td><strong>${m.sr}</strong></td>
    <td class="${pc(m.snP)}">${m.snP}</td><td class="${pc(m.trP)}">${m.trP}</td>
    <td>${m.by||'N/A'}</td><td>${m.desc}</td></tr>`).join('')}
  </tbody></table>`;
}

function renderSummary(incomplete, allTr) {
  const totals = {};
  allTr.forEach(r => {
    const p = (r['Worked By']||'').trim();
    if (p && p.toLowerCase() !== 'unassigned') totals[p] = (totals[p]||0)+1;
  });

  const sum = {};
  Object.keys(incomplete).forEach(p => {
    if (!p || p.toLowerCase() === 'unassigned') return;
    const entries = incomplete[p];
    const freq = {};
    entries.forEach(e => e.fields.forEach(f => { freq[f]=(freq[f]||0)+1; }));
    const top = Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([f,c])=>`${f} (${c})`).join(', ');
    const totalM = entries.reduce((s,e)=>s+e.fields.length,0);
    sum[p] = { total:totals[p]||entries.length, with:entries.length, totalM, avg:(totalM/entries.length).toFixed(1), top };
  });

  const grand = Object.values(sum).reduce((s,v)=>s+v.with,0);
  document.getElementById('c4').textContent = grand;
  document.getElementById('c5').textContent = Object.values(incomplete).reduce((s,a)=>s+a.length,0);

  const c = document.getElementById('t4');
  if (!grand) { c.innerHTML = empty('No missing fields found'); return; }

  c.innerHTML = `<table><thead><tr><th>Team Member</th><th>Total</th><th>Incomplete</th><th>Missing Fields</th><th>Avg/Incident</th><th>Most Missing</th></tr></thead><tbody>
    ${Object.keys(sum).sort((a,b)=>sum[b].with-sum[a].with).map(p => {
      const s = sum[p];
      const pct = ((s.with/s.total)*100).toFixed(0);
      return `<tr><td><strong>${p}</strong></td><td>${s.total}</td>
        <td>${s.with} <span style="color:var(--text-dim);font-size:.75em;">(${pct}%)</span>
          <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
        </td>
        <td><span style="color:var(--danger);font-weight:600;">${s.totalM}</span></td>
        <td>${s.avg}</td><td style="color:var(--text-dim);font-size:.72em;">${s.top||'N/A'}</td></tr>`;
    }).join('')}
  </tbody></table>`;
}

function renderDetailed(incomplete) {
  const c = document.getElementById('t5');
  const all = Object.values(incomplete).reduce((s,a)=>s+a.length,0);
  if (!all) { c.innerHTML = empty('All entries are complete'); return; }

  c.innerHTML = Object.keys(incomplete).sort().map(person => {
    const entries = incomplete[person];
    return `<div class="person-block">
      <div class="person-head">
        <div class="person-head-name">${person}</div>
        <span class="pill pill-blue">${entries.length} incomplete</span>
      </div>
      <div style="padding:12px 16px;">
      <table><thead><tr><th style="width:14%">SR#</th><th style="width:46%">Missing Fields</th><th>Description</th></tr></thead><tbody>
        ${entries.map(e=>`<tr><td><strong>${e.sr}</strong></td>
          <td>${e.fields.map(f=>`<span class="tag">${f}</span>`).join('')}</td>
          <td style="color:var(--text-dim);font-size:.75em;">${e.description}</td></tr>`).join('')}
      </tbody></table></div></div>`;
  }).join('');
}

function renderDups(dups) {
  const groups = Object.keys(dups).length;
  const rows = Object.values(dups).reduce((s,a)=>s+a.length,0);
  document.getElementById('c6').textContent = groups > 0 ? `${groups} SR${groups>1?'s':''} (${rows} rows)` : '0';
  const c = document.getElementById('t6');
  if (!groups) { c.innerHTML = empty('No duplicates found'); return; }

  c.innerHTML = Object.keys(dups).sort().map(sr => {
    const entries = dups[sr];
    return `<div class="person-block" style="border-color:rgba(192,132,252,.2);">
      <div class="person-head" style="background:rgba(192,132,252,.06);">
        <span style="color:var(--purple);font-weight:600;">SR# ${sr}</span>
        <span class="pill pill-purple">${entries.length} duplicates</span>
      </div>
      <div style="padding:12px 16px;">
      <table><thead><tr><th>Row</th><th>Description</th><th>Worked By</th><th>Priority</th><th>Status</th></tr></thead><tbody>
        ${entries.map(({row,idx})=>`<tr>
          <td><strong>Row ${idx}</strong></td>
          <td>${row['Description']||'N/A'}</td>
          <td>${row['Worked By']||'N/A'}</td>
          <td class="${pc(row['Priority']||'')}">${row['Priority']||'N/A'}</td>
          <td>${row['Status']||'N/A'}</td></tr>`).join('')}
      </tbody></table></div></div>`;
  }).join('');
}

// ‚îÄ‚îÄ FORM GENERATOR ‚îÄ‚îÄ
function buildFormGen(incomplete, allTr) {
  const people = Object.keys(incomplete).filter(p => p && p.toLowerCase() !== 'unassigned');
  if (!people.length) { document.getElementById('formgenPanel').style.display='none'; return; }

  document.getElementById('formgenPanel').style.display = 'block';

  document.getElementById('personCards').innerHTML = people
    .sort((a,b) => incomplete[b].length - incomplete[a].length)
    .map((person, i) => {
      const entries = incomplete[person];
      const totalFields = entries.reduce((s,e)=>s+e.fields.length,0);
      const initials = person.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
      const color = AVATAR_COLORS[i % AVATAR_COLORS.length];
      return `<div class="person-card" onclick="openPersonModal('${person.replace(/'/g,"\\'")}')">
        <div class="p-avatar" style="background:${color}">${initials}</div>
        <div class="p-name">${person}</div>
        <div class="p-stats"><strong>${entries.length}</strong> incidents ¬∑ <strong>${totalFields}</strong> missing</div>
      </div>`;
    }).join('');
}

function buildShareLink(person) {
  const entries = allIncomplete[person];
  if (!entries) return '';

  const payload = {
    person,
    generatedAt: new Date().toISOString(),
    entries: entries.map(e => ({ sr: e.sr, description: e.description, fields: e.fields }))
  };

  const encoded = btoa(encodeURIComponent(JSON.stringify(payload)));
  return `${GITHUB_PAGES_BASE}/form.html?data=${encoded}`;
}

function openPersonModal(person) {
  currentPerson = person;
  const entries = allIncomplete[person];
  const totalFields = entries.reduce((s,e)=>s+e.fields.length,0);

  document.getElementById('modalTitle').textContent = person;
  document.getElementById('modalSub').textContent = `${entries.length} incomplete incident${entries.length>1?'s':''} ¬∑ ${totalFields} missing fields`;

  const link = buildShareLink(person);
  document.getElementById('shareLink').value = link;

  document.getElementById('linkModal').classList.add('open');
}

function closeModal() {
  document.getElementById('linkModal').classList.remove('open');
  currentPerson = null;
}

document.getElementById('linkModal').addEventListener('click', e => { if(e.target === e.currentTarget) closeModal(); });

function copyShareLink() {
  const val = document.getElementById('shareLink').value;
  navigator.clipboard.writeText(val).then(() => toast('‚úì Link copied to clipboard'));
}

function copyAllLinks() {
  const people = Object.keys(allIncomplete).filter(p => p && p.toLowerCase() !== 'unassigned');
  const lines = people.map(p => `${p}:\n${buildShareLink(p)}`).join('\n\n');
  navigator.clipboard.writeText(lines).then(() => toast(`‚úì ${people.length} links copied`));
}

// ‚îÄ‚îÄ RESPONSES ‚îÄ‚îÄ
async function loadResponses() {
  const url = getAppsScriptUrl();
  if (!url) { toast('‚ö†Ô∏è Paste your Apps Script URL in the top bar first'); return; }

  document.getElementById('responsesTable').innerHTML = '<div class="empty"><div style="font-size:1.4rem;">‚è≥</div>Loading responses‚Ä¶</div>';

  try {
    const res = await fetch(`${url}?action=read`);
    const data = await res.json();

    if (data.status !== 'ok') throw new Error(data.message || 'Unknown error');

    const rows = data.data;
    document.getElementById('respCount').textContent = rows.length;

    if (!rows.length) {
      document.getElementById('responsesTable').innerHTML = '<div class="empty"><div class="ck">üì≠</div>No responses yet</div>';
      return;
    }

    const headers = Object.keys(rows[0]);
    document.getElementById('responsesTable').innerHTML = `
      <table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>
        ${rows.map(row=>`<tr>${headers.map(h=>`<td>${row[h]||'‚Äî'}</td>`).join('')}</tr>`).join('')}
      </tbody></table>`;
  } catch(e) {
    document.getElementById('responsesTable').innerHTML = `<div class="empty" style="color:var(--danger);">Error loading responses: ${e.message}</div>`;
  }
}

function exportResponsesToCSV() {
  const table = document.querySelector('#responsesTable table');
  if (!table) { toast('No data to export'); return; }

  const rows = [];
  table.querySelectorAll('tr').forEach(tr => {
    const cells = Array.from(tr.querySelectorAll('th,td')).map(c => `"${c.textContent.replace(/"/g,'""')}"`);
    rows.push(cells.join(','));
  });

  const blob = new Blob([rows.join('\n')], { type:'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `responses_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  toast('‚¨á CSV downloaded');
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast'; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
loadConfig();
</script>
</body>
</html>
